name: Deploy Yandex Cloud Function

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Zip function code
        run: |
          mkdir function
          cp -r src package.json package-lock.json function/
          cd function
          zip -r ../function.zip ./*
          cd ..

      - name: Install Yandex CLI
        run: |
          curl https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          export PATH="$HOME/bin:$PATH"
          yc version

      - name: Authenticate Yandex Cloud
        run: |
          yc config set token ${{ secrets.YC_TOKEN }}
          yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

      - name: Deploy function
        run: |
          yc serverless function version create \
            --function-name load-schedule \
            --runtime nodejs22 \
            --entrypoint src/handler.handler \
            --memory 128m \
            --execution-timeout 10s \
            --source-path function.zip \
            --environment "NODE_ENV=production" \
            --secret environment-variables=load-schedule-env
